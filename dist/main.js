class t{constructor(t,e){this.videoElement=t,this.attachedVideoEvents=new Set,this.attachedWindowEvents=new Set,this.config=e,this.running=!1,this._processEvent=this.processEvent.bind(this),this.start()}attachEvent(t,e,s){s.has(t)||(e.addEventListener(t,this._processEvent),s.add(t))}detachEvent(t,e,s){s.has(t)&&(e.removeEventListener(t,this._processEvent),s.delete(t))}processEvent(t){const e=this.config[`capture-${t.type}`]?this.config[`capture-${t.type}`](t,this):this.config.captureDefault(t,this);if(e.skip)return;const s=parseInt(localStorage.getItem("videometrics-last-index"))||0,i=parseInt(localStorage.getItem("videometrics-last-send"))||Date.now(),n=JSON.stringify({...this.config.customData,when:Date.now(),type:t.type,...e});localStorage.getItem("videometrics-"+(s-1))!==n&&(localStorage.setItem("videometrics-last-index",s+1),localStorage.setItem(`videometrics-${s}`,n),(s>this.config.bulkSize||i+this.config.interval<Date.now())&&this.bulk(n))}async bulk(){const t=this.config.firstRow?[this.config.firstRow]:[];let e=parseIndex(localStorage.getItem("videometrics-last-index"))||0;if(0!==e){for(;e--;)t.push(localStorage.getItem(`videometrics-${e}`));if(t.push(newItem),await this.config.send(this,t))for(localStorage.setItem("videometrics-last-index",0),localStorage.setItem("videometrics-last-send",Date.now());e--;)localStorage.removeItem(`videometrics-${e}`)}else localStorage.setItem("videometrics-last-send",Date.now())}start(){this.running||(this.config.videoEvents.forEach((t=>this.attachEvent(t,this.videoElement,this.attachedVideoEvents))),this.config.windowEvents.forEach((t=>this.attachEvent(t,window,this.attachedWindowEvents))),this.running=!0)}stop(){this.attachedVideoEvents.forEach((t=>this.videoElement.removeEventListener(t,this._processEvent))),this.attachedWindowEvents.forEach((t=>this.window.removeEventListener(t,this._processEvent))),this.attachedVideoEvents.clear(),this.attachedWindowEvents.clear(),this.running=!1}}export{t as default};